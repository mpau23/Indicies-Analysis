IndiciesAnalysis.controller("RootCtrl",["$scope","$http","$q","MarketDataService","CalendarDataService",function(e,t,a,n,r){function o(){var t=n.getDailyMarketData(2e3),o=r.getMonthlyOptions(12,2e3);a.all([t]).then(function(t){var a=t[0];angular.forEach(o,function(e,t){var n=Date.parse(e.expiry.date),r=Date.parse(e.open.date),o=a[n.getTime()],i=a[r.getTime()];if(o?(e.expiry.open=o.open,e.expiry.close=o.close,e.expiry.high=o.high,e.expiry.low=o.low):console.log(n+": not in market data"),i?(e.open.open=i.open,e.open.close=i.close,e.open.high=i.high,e.open.low=i.low):console.log(r+": not in market data"),o&&i){e.variance=(o.close-i.open)/i.open;for(var c=e.open.high,l=e.open.low;n>r;)r.addWeekdays(1),a[r.getTime()]&&(a[r.getTime()].high>c&&(c=a[r.getTime()].high),a[r.getTime()].low<l&&(l=a[r.getTime()].low)),e.highestHigh=c,e.lowestLow=l;e.variance>0?e.highLowVariance=(c-e.open.open)/e.open.open-e.variance:e.highLowVariance=(l-e.open.open)/e.open.open-e.variance}}),console.log(o),e.marketData=o})}o()}]),IndiciesAnalysis.factory("CalendarDataService",["$http","$q",function(e,t){var a={getMonthlyExpiries:function(e){var t=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+e),r=n.moveToNthOccurrence(5,3);for(t.push({expiry:{date:r.toString("d-MMM-yyyy")}});a>r;)n.addMonths(1),r=n.moveToNthOccurrence(5,3),t.push({expiry:{date:r.toString("d-MMM-yyyy")}});return t},getMonthlyOptions:function(e,t){var n=a.getMonthlyExpiries(t);return angular.forEach(n,function(t,a){var n=Date.parse(t.expiry.date);n.addWeekdays(-e),t.open={date:n.toString("d-MMM-yyyy")}}),n}};return a}]),IndiciesAnalysis.factory("MarketDataService",["$http","$q",function(e,t){var a={getDailyMarketData:function(a){return marketDataPromise=e.get("/api/get/market-data/daily/"+a).then(function(e){if(e){var a=[];return angular.forEach(e.data.dataset.data,function(e,t){var n=Date.parse(e[0]);a[n.getTime()]={date:e[0],open:e[1],high:e[2],low:e[3],close:e[4]}}),a}return t.reject})}};return a}]),IndiciesAnalysis.directive("indiciesChartDirective",["$parse","$window",function(e,t){return{restrict:"EA",template:"<svg class='chart'></svg>",link:function(a,n,r){function o(){s=g.scale.ordinal().rangeRoundBands([0,y],.1),h=g.svg.axis().scale(s).orient("bottom"),s.domain(l.map(function(e){return e.expiry.date})),p=g.scale.linear().range([f,0]),d=g.svg.axis().scale(p).orient("left").ticks(20,"%"),p.domain(g.extent(l,function(e){return e.variance})).nice()}function i(){o(),v.append("g").attr("class","x axis").attr("transform","translate(0,"+p(0)+")").call(h).selectAll("text").style("display","none"),v.append("g").attr("class","y axis").call(d),v.selectAll(".bar").data(l).enter().append("rect").attr("class","bar").attr("x",function(e){return s(e.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(e){return e.variance?p(Math.max(0,e.variance)):0}).attr("height",function(e){return e.variance?Math.abs(p(e.variance)-p(0)):0})}var c=e(r.chartData);console.log(c);var l=c(a);console.log(l);var s,p,h,d,g=t.d3,u={top:20,right:20,bottom:30,left:40},y=1280-u.left-u.right,f=720-u.top-u.bottom,v=g.select(".chart").attr("width",y+u.left+u.right).attr("height",f+u.top+u.bottom).append("g").attr("transform","translate("+u.left+","+u.top+")");a.$watchCollection(c,function(e,t){l=e,l&&i()})}}}]),IndiciesAnalysis.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,a){a.html5Mode(!0),t.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"})}]);