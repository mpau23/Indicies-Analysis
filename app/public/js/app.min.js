IndiciesAnalysis.controller("RootCtrl",["$scope","$http","$q","MarketDataService","CalendarDataService",function(e,t,a,r,n){function i(t,i){t||(t=15),i||(i="SPY");var o=r.getDailyMarketData(2e3,i),c=n.getMonthlyOptions(t,2e3);a.all([o]).then(function(t){var a=t[0];angular.forEach(c,function(e,t){var r=Date.parse(e.expiry.date),n=Date.parse(e.open.date),i=a[r.getTime()],o=a[n.getTime()];if(i?(e.expiry.open=i.open,e.expiry.close=i.close,e.expiry.high=i.high,e.expiry.low=i.low):console.log(r+": not in market data"),o?(e.open.open=o.open,e.open.close=o.close,e.open.high=o.high,e.open.low=o.low):console.log(n+": not in market data"),i&&o){e.variance=(i.close-o.open)/o.open;for(var c=e.open.high,l=e.open.low;r>n;)n.addWeekdays(1),a[n.getTime()]&&(a[n.getTime()].high>c&&(c=a[n.getTime()].high),a[n.getTime()].low<l&&(l=a[n.getTime()].low)),e.highestHigh=c,e.lowestLow=l;e.variance>0?e.highLowVariance=(c-e.open.open)/e.open.open-e.variance:e.highLowVariance=(l-e.open.open)/e.open.open-e.variance}}),e.marketData=c})}i(),e.marketKeys=["SPY","FTSE","GDAXI"],e.changeDaysToExpiry=function(){i(e.daysToExpiry,e.marketKey)}}]),IndiciesAnalysis.factory("CalendarDataService",["$http","$q",function(e,t){var a={getMonthlyExpiries:function(e){var t=new Array,a=Date.parse("today"),r=Date.parse("1-1-"+e),n=r.moveToNthOccurrence(5,3);for(t.push({expiry:{date:n.toString("d-MMM-yyyy")}});a>n;)r.addMonths(1),n=r.moveToNthOccurrence(5,3),t.push({expiry:{date:n.toString("d-MMM-yyyy")}});return t},getMonthlyOptions:function(e,t){var r=a.getMonthlyExpiries(t);return angular.forEach(r,function(t,a){var r=Date.parse(t.expiry.date);r.addWeekdays(-e),t.open={date:r.toString("d-MMM-yyyy")}}),r}};return a}]),IndiciesAnalysis.factory("MarketDataService",["$http","$q",function(e,t){var a={getDailyMarketData:function(a,r){return marketDataPromise=e.get("/api/get/market-data/local/daily/"+r).then(function(e){if(e){var a=[];return angular.forEach(e.data,function(e,t){var r=Date.parse(e.Date);a[r.getTime()]={date:e.Date,open:e.Open,high:e.High,low:e.Low,close:e.Close}}),a}return t.reject})}};return a}]),IndiciesAnalysis.directive("indiciesChartDirective",["$parse","$window",function(e,t){return{restrict:"EA",template:"<svg class='chart'></svg>",link:function(a,r,n){function i(){l=u.scale.ordinal().rangeRoundBands([0,f],.1),p=u.svg.axis().scale(l).orient("bottom"),l.domain(g.map(function(e){return e.expiry.date})),s=u.scale.linear().range([v,0]),h=u.svg.axis().scale(s).orient("left").ticks(20,"%"),s.domain(u.extent(g,function(e){return e.variance})).nice()}function o(){i(),m.append("g").attr("class","x axis").attr("transform","translate(0,"+s(0)+")").call(p).selectAll("text").style("display","none"),m.append("g").attr("class","y axis").call(h),m.selectAll(".bar").data(g).enter().append("rect").attr("class","bar").attr("x",function(e){return l(e.expiry.date)}).attr("width",l.rangeBand()).attr("y",function(e){return e.variance?s(Math.max(0,e.variance)):0}).attr("height",function(e){return e.variance?Math.abs(s(e.variance)-s(0)):0})}function c(e){i(),m.selectAll("g.y").call(h),m.selectAll("g.x").attr("transform","translate(0,"+s(0)+")").call(p),m.selectAll(".bar").remove(),m.selectAll("g.bar").data(g).enter().append("rect").attr("class","bar").attr("x",function(e){return l(e.expiry.date)}).attr("width",l.rangeBand()).attr("y",function(e){return e.variance?s(Math.max(0,e.variance)):0}).attr("height",function(e){return e.variance?Math.abs(s(e.variance)-s(0)):0})}var l,s,p,h,d=e(n.chartData),g=d(a),u=t.d3,y={top:20,right:20,bottom:30,left:40},f=1280-y.left-y.right,v=720-y.top-y.bottom,m=u.select(".chart").attr("width",f+y.left+y.right).attr("height",v+y.top+y.bottom).append("g").attr("transform","translate("+y.left+","+y.top+")");a.$watchCollection(d,function(e,t){g=e,g&&(t?c(t):o())})}}}]),IndiciesAnalysis.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,a){a.html5Mode(!0),t.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"})}]);