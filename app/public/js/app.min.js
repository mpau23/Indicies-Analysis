IndiciesAnalysis.controller("RootCtrl",["$scope","$http","$q","MarketDataService","CalendarDataService",function(e,t,a,n,i){function r(t,r){t||(t=15),r||(r="SPY");var o=n.getDailyMarketData(2e3,r),l=n.getVolatilityData(2e3),s=i.getMonthlyOptions(t,2e3);a.all([o,l]).then(function(t){var a=t[0],n=t[1];angular.forEach(s,function(e,t){for(var i=Date.parse(e.expiry.date),r=Date.parse(e.open.date),o=a[i.getTime()],l=a[r.getTime()],s=5,c=0,p=0;!o&&s>=c;)i.addDays(1),o=a[i.getTime()],c++;for(c=0;!l&&s>=p;)r.addDays(1),l=a[r.getTime()],p++;p=0;n[i.getTime()],n[r.getTime()];if(o&&l){e.expiry.date=i.toString("d-MMM-yyyy"),e.expiry.open=o.open,e.expiry.close=o.close,e.expiry.high=o.high,e.expiry.low=o.low;for(var d=new Date(i.getTime()),h=new Date(r.getTime()),g=0,y=0;!n[d.getTime()]&&s>=g;)d.addDays(-1),g++;for(;!n[h.getTime()]&&s>=y;)h.addDays(-1),y++;0==g?e.expiry.volatility=n[d.getTime()].open:e.expiry.volatility=n[d.getTime()].close,0==y?e.open.volatility=n[h.getTime()].open:e.open.volatility=n[h.getTime()].close,e.open.date=r.toString("d-MMM-yyyy"),e.open.open=l.open,e.open.close=l.close,e.open.high=l.high,e.open.low=l.low,e.variance=(o.close-l.open)/l.open;for(var u=e.open.high,v=e.open.low;i>r;)r.addDays(1),a[r.getTime()]&&(a[r.getTime()].high>u&&(u=a[r.getTime()].high),a[r.getTime()].low<v&&(v=a[r.getTime()].low)),e.highestHigh=u,e.lowestLow=v;e.variance>0?e.highLowVariance=(u-e.open.open)/e.open.open-e.variance:e.highLowVariance=(v-e.open.open)/e.open.open-e.variance}else console.log("No market data for: Expiry="+i+", Open="+r)}),e.marketData=s})}r(),e.marketKeys=["SPY","FTSE","GDAXI"],e.changeDaysToExpiry=function(){r(e.daysToExpiry,e.marketKey)}}]),IndiciesAnalysis.factory("CalendarDataService",["$http","$q",function(e,t){var a={getMonthlyExpiries:function(e){var t=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+e),i=n.moveToNthOccurrence(5,3);for(t.push({expiry:{date:i.toString("d-MMM-yyyy")}});a>i;)n.addMonths(1),i=n.moveToNthOccurrence(5,3),t.push({expiry:{date:i.toString("d-MMM-yyyy")}});return t},getMonthlyOptions:function(e,t){var n=a.getMonthlyExpiries(t);return angular.forEach(n,function(t,a){var n=Date.parse(t.expiry.date);n.addDays(-e),t.open={date:n.toString("d-MMM-yyyy")}}),n}};return a}]),IndiciesAnalysis.factory("MarketDataService",["$http","$q",function(e,t){var a={getDailyMarketData:function(a,n){return marketDataPromise=e.get("/api/get/market-data/local/daily/"+n).then(function(e){if(e){var a=[];return angular.forEach(e.data,function(e,t){var n=Date.parse(e.Date);a[n.getTime()]={date:e.Date,open:e.Open,high:e.High,low:e.Low,close:e.Close}}),a}return t.reject})},getVolatilityData:function(a){return marketDataPromise=e.get("/api/get/market-data/local/daily/VIX").then(function(e){if(e){var a=[];return angular.forEach(e.data,function(e,t){var n=Date.parse(e.Date);a[n.getTime()]={date:e.Date,open:e.Open,high:e.High,low:e.Low,close:e.Close}}),a}return t.reject})}};return a}]),IndiciesAnalysis.directive("indiciesChartDirective",["$parse","$window",function(e,t){return{restrict:"EA",template:"<svg class='chart'></svg>",link:function(a,n,i){function r(){l=u.scale.ordinal().rangeRoundBands([0,f],.3),c=u.svg.axis().scale(l).orient("bottom"),l.domain(y.map(function(e){return e.expiry.date})),s=u.scale.linear().range([m,0]),p=u.svg.axis().scale(s).orient("left").ticks(20,"%").tickSize(-f,0,0),s.domain(u.extent(y,function(e){return e.variance+e.highLowVariance})).nice(),y2=u.scale.linear().range([s(0),0]),y2Axis=u.svg.axis().scale(y2).orient("right").ticks(8,"%").tickSize(-f,0,0),y2.domain(u.extent(y,function(e){return e.open.volatility?e.open.volatility/100:0})).nice(),h=u.svg.line().x(function(e){return l(e.expiry.date)}).y(function(e){return e.open.volatility?y2(e.open.volatility/100):y2(0)}).interpolate("linear"),d=u.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return" <div><span class='title'>Variance: </span><span class='value'>"+(100*e.variance).toFixed(2)+"%</span></div><div><span class='title'>High / Low Variance: </span><span class='value'> "+(100*e.highLowVariance).toFixed(2)+"%</span></div><div><span class='title'>Open Date: </span><span class='value'> "+e.open.date+" </span></div><div><span class='title'>Open Price: </span><span class='value'> "+e.open.open.toFixed(2)+" </span></div><div><span class='title'>Expiry Date: </span><span class='value'>"+e.expiry.date+" </span></div><div><span class='title'>Expiry Price: </span><span class='value'> "+e.expiry.close.toFixed(2)+" </span></div>"}),x.call(d)}function o(e){r(),e?(x.selectAll("g.y").call(p),x.selectAll("g.y2").call(y2Axis),x.selectAll("g.x").attr("transform","translate(0,"+s(0)+")").call(c),x.selectAll(".bar").remove(),x.selectAll(".line").remove()):(x.append("g").attr("class","x axis").attr("transform","translate(0,"+s(0)+")").call(c).selectAll("text"),x.append("g").attr("class","y axis").call(p),x.append("g").attr("class","y2 axis").attr("transform","translate("+f+" ,0)").call(y2Axis)),x.selectAll(".graph-container.bar").data(y).enter().append("rect").attr("class","bar highlow").attr("data-value",function(e){return e.highLowVariance}).attr("x",function(e){return l(e.expiry.date)}).attr("width",l.rangeBand()).attr("y",function(e){return e.highLowVariance?s(Math.max(0,e.highLowVariance+e.variance)):0}).attr("height",function(e){return e.highLowVariance?Math.abs(s(e.highLowVariance+e.variance)-s(0)):0}).on("mouseover",d.show).on("mouseout",d.hide),x.selectAll(".graph-container.bar").data(y).enter().append("rect").attr("class","bar variance").attr("data-value",function(e){return e.variance}).attr("x",function(e){return l(e.expiry.date)}).attr("width",l.rangeBand()).attr("y",function(e){return e.variance?s(Math.max(0,e.variance)):0}).attr("height",function(e){return e.variance?Math.abs(s(e.variance)-s(0)):0}).on("mouseover",d.show).on("mouseout",d.hide),x.append("path").attr("class","line").attr("d",h(y))}var l,s,c,p,d,h,g=e(i.chartData),y=g(a),u=t.d3,v={top:20,right:20,bottom:30,left:40},f=1280-v.left-v.right,m=700-v.top-v.bottom,x=u.select(".chart").attr("width",f+v.left+v.right).attr("height",m+v.top+v.bottom).append("g").attr("transform","translate("+v.left+","+v.top+")").attr("class","graph-container");a.$watchCollection(g,function(e,t){y=e;var a=!1;y&&(t&&(a=!0),o(a))})}}}]),IndiciesAnalysis.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,a){a.html5Mode(!0),t.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"})}]);var jq=jQuery.noConflict();jq(document).on("mouseenter",".tick text",function(){jq(this).prev("line").css("opacity","1")}),jq(document).on("mouseleave",".tick text",function(){jq(this).prev("line").css("opacity","0")});