IndiciesAnalysis.controller("RootCtrl",["$scope","$http","$q","MarketDataService","CalendarDataService",function(t,e,a,n,r){function i(e,i){e||(e=15),i||(i="SPY");var o=n.getDailyMarketData(2e3,i),c=r.getMonthlyOptions(e,2e3);a.all([o]).then(function(e){var a=e[0];angular.forEach(c,function(t,e){for(var n=Date.parse(t.expiry.date),r=Date.parse(t.open.date),i=a[n.getTime()],o=a[r.getTime()],c=5,s=0,l=0;!i&&c>=s;)n.addDays(1),i=a[n.getTime()],s++;for(s=0;!o&&c>=l;)r.addDays(1),o=a[r.getTime()],l++;if(l=0,i&&o){t.expiry.date=n.toString("d-MMM-yyyy"),t.expiry.open=i.open,t.expiry.close=i.close,t.expiry.high=i.high,t.expiry.low=i.low,t.open.date=r.toString("d-MMM-yyyy"),t.open.open=o.open,t.open.close=o.close,t.open.high=o.high,t.open.low=o.low,t.variance=(i.close-o.open)/o.open;for(var h=t.open.high,d=t.open.low;n>r;)r.addDays(1),a[r.getTime()]&&(a[r.getTime()].high>h&&(h=a[r.getTime()].high),a[r.getTime()].low<d&&(d=a[r.getTime()].low)),t.highestHigh=h,t.lowestLow=d;t.variance>0?t.highLowVariance=(h-t.open.open)/t.open.open-t.variance:t.highLowVariance=(d-t.open.open)/t.open.open-t.variance}else console.log("No market data for: Expiry="+n+", Open="+r)}),t.marketData=c})}i(),t.marketKeys=["SPY","FTSE","GDAXI"],t.changeDaysToExpiry=function(){i(t.daysToExpiry,t.marketKey)}}]),IndiciesAnalysis.factory("CalendarDataService",["$http","$q",function(t,e){var a={getMonthlyExpiries:function(t){var e=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+t),r=n.moveToNthOccurrence(5,3);for(e.push({expiry:{date:r.toString("d-MMM-yyyy")}});a>r;)n.addMonths(1),r=n.moveToNthOccurrence(5,3),e.push({expiry:{date:r.toString("d-MMM-yyyy")}});return e},getMonthlyOptions:function(t,e){var n=a.getMonthlyExpiries(e);return angular.forEach(n,function(e,a){var n=Date.parse(e.expiry.date);n.addDays(-t),e.open={date:n.toString("d-MMM-yyyy")}}),n}};return a}]),IndiciesAnalysis.factory("MarketDataService",["$http","$q",function(t,e){var a={getDailyMarketData:function(a,n){return marketDataPromise=t.get("/api/get/market-data/local/daily/"+n).then(function(t){if(t){var a=[];return angular.forEach(t.data,function(t,e){var n=Date.parse(t.Date);a[n.getTime()]={date:t.Date,open:t.Open,high:t.High,low:t.Low,close:t.Close}}),a}return e.reject})}};return a}]),IndiciesAnalysis.directive("indiciesChartDirective",["$parse","$window",function(t,e){return{restrict:"EA",template:"<svg class='chart'></svg>",link:function(a,n,r){function i(){s=y.scale.ordinal().rangeRoundBands([0,f],.1),h=y.svg.axis().scale(s).orient("bottom"),s.domain(g.map(function(t){return t.expiry.date})),l=y.scale.linear().range([m,0]),l.domain(y.extent(g,function(t){return t.variance})).nice(),d=y.svg.axis().scale(l).orient("left").ticks(20,"%").tickSize(-f,0,0),p=y.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return"\n                            <div>\n                                <strong>Variance:</strong> \n                                <span style='color:red'>"+(100*t.variance).toFixed(2)+"%</span>\n                            </div>\n                            <div>\n                                <strong>High/Low Variance:</strong> \n                                <span style='color:red'>"+(100*t.highLowVariance).toFixed(2)+"%</span>\n                            </div>\n                            <div>\n                                <strong>Open Date</strong>\n                                <span style='color:red'>"+t.open.date+"</span>\n                            </div>\n                            <div>\n                                <strong>Open Price</strong>\n                                <span style='color:red'>"+t.expiry.open.toFixed(2)+"</span>\n                            </div>\n                            <div>\n                                <strong>Expiry Date</strong>\n                                <span style='color:red'>"+t.expiry.date+"</span>\n                            </div>\n                            <div>\n                                <strong>Expiry Price</strong>\n                                <span style='color:red'>"+t.expiry.close.toFixed(2)+"</span>\n                            </div>"}),x.call(p)}function o(){i(),x.append("g").attr("class","x axis").attr("transform","translate(0,"+l(0)+")").call(h).selectAll("text"),x.append("g").attr("class","y axis").call(d),x.selectAll("g.bar").data(g).enter().append("rect").attr("class","bar highlow").attr("data-value",function(t){return t.highLowVariance}).attr("x",function(t){return s(t.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(t){return t.highLowVariance?l(Math.max(0,t.highLowVariance+t.variance)):0}).attr("height",function(t){return t.highLowVariance?Math.abs(l(t.highLowVariance+t.variance)-l(0)):0}).on("mouseover",p.show).on("mouseout",p.hide),x.selectAll("g.bar").data(g).enter().append("rect").attr("class","bar variance").attr("data-value",function(t){return t.variance}).attr("x",function(t){return s(t.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(t){return t.variance?l(Math.max(0,t.variance)):0}).attr("height",function(t){return t.variance?Math.abs(l(t.variance)-l(0)):0}).on("mouseover",p.show).on("mouseout",p.hide)}function c(t){i(),x.selectAll("g.y").call(d),x.selectAll("g.x").attr("transform","translate(0,"+l(0)+")").call(h),x.selectAll(".bar").remove(),x.selectAll("g.bar").data(g).enter().append("rect").attr("class","bar highlow").attr("data-value",function(t){return t.highLowVariance}).attr("x",function(t){return s(t.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(t){return t.highLowVariance?l(Math.max(0,t.highLowVariance+t.variance)):0}).attr("height",function(t){return t.highLowVariance?Math.abs(l(t.highLowVariance+t.variance)-l(0)):0}).on("mouseover",p.show).on("mouseout",p.hide),x.selectAll("g.bar").data(g).enter().append("rect").attr("class","bar variance").attr("data-value",function(t){return t.variance}).attr("x",function(t){return s(t.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(t){return t.variance?l(Math.max(0,t.variance)):0}).attr("height",function(t){return t.variance?Math.abs(l(t.variance)-l(0)):0}).on("mouseover",p.show).on("mouseout",p.hide)}var s,l,h,d,p,u=t(r.chartData),g=u(a),y=e.d3,v={top:20,right:20,bottom:30,left:40},f=1280-v.left-v.right,m=620-v.top-v.bottom,x=y.select(".chart").attr("width",f+v.left+v.right).attr("height",m+v.top+v.bottom).append("g").attr("transform","translate("+v.left+","+v.top+")");a.$watchCollection(u,function(t,e){g=t,g&&(e?c(e):o())})}}}]),IndiciesAnalysis.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t,e,a){a.html5Mode(!0),e.otherwise("/"),t.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"})}]);var jq=jQuery.noConflict();jq(document).on("mouseenter",".tick text",function(){jq(this).prev("line").css("opacity","1")}),jq(document).on("mouseleave",".tick text",function(){jq(this).prev("line").css("opacity","0")});