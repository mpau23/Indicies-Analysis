IndiciesAnalysis.controller("LoginCtrl",["$scope","$location","AuthenticationService",function(e,t,a){e.formError=!1,e.username="",e.password="",a.clearCredentials(),e.tryLogin=function(){a.login(e.username,e.password,function(n){e.shakeError=!1,n.success?(a.setCredentials(e.username,e.password),t.path("/")):(e.error=n.error,e.formError=!0)})}}]),IndiciesAnalysis.controller("RootCtrl",["$scope","$http","$q","MarketDataService","CalendarDataService","OptionCalculationService",function(e,t,a,n,r,i){function o(t,o,s,c,l){t||(t="SPY"),o||(o=15),s||(s=0),c||(c="monthly"),l||(l=2e3);var p=n.getDailyMarketData(l,t),d=n.getVolatilityData(l),u=r.getOptions(o,l,c);a.all([p,d]).then(function(t){var a=t[0],n=t[1];if(a&&n){i.getOptionData(a,n,u,s)}e.marketData=u})}o("SPY",15,0,"monthly",2e3),e.marketKeys=["SPY","FTSE","GDAXI","SLV","QQQ","IWM"],e.marketKey={value:e.marketKeys[0]},e.optionTypes=["weekly","monthly"],e.optionType={value:e.optionTypes[1]},e.changeDaysToExpiry=function(){console.log(e.marketKey.value),console.log(e.optionType.value),o(e.marketKey.value,e.openBeforeExpiry,e.closeBeforeExpiry,e.optionType.value,e.startYear)}}]),IndiciesAnalysis.factory("AuthenticationService",["Base64Service","$http","$cookies","$rootScope",function(e,t,a,n){var r={login:function(a,n,r){console.log("Attempting to log in"),t.get("/api/get/user/by-login/"+e.encode(a+":"+n)).then(function(e){r(e.data)})},setCredentials:function(r,i){console.log("Setting credentials");var o=e.encode(r+":"+i);console.log("Basic "+o),n.currentUser=o,t.defaults.headers.common.Authorization="Basic "+o;var s=new Date;s.addHours(1),a.put("currentUser",n.currentUser,{expires:s})},clearCredentials:function(){delete n.currentUser,a.remove("currentUser"),t.defaults.headers.common.Authorization="Basic auth"}};return r}]),IndiciesAnalysis.factory("Base64Service",function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var a,n,r,i,o,s="",c="",l="",p=0;do a=t.charCodeAt(p++),n=t.charCodeAt(p++),c=t.charCodeAt(p++),r=a>>2,i=(3&a)<<4|n>>4,o=(15&n)<<2|c>>6,l=63&c,isNaN(n)?o=l=64:isNaN(c)&&(l=64),s=s+e.charAt(r)+e.charAt(i)+e.charAt(o)+e.charAt(l),a=n=c="",r=i=o=l="";while(p<t.length);return s},decode:function(t){var a,n,r,i,o,s="",c="",l="",p=0,d=/[^A-Za-z0-9\+\/\=]/g;d.exec(t)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do r=e.indexOf(t.charAt(p++)),i=e.indexOf(t.charAt(p++)),o=e.indexOf(t.charAt(p++)),l=e.indexOf(t.charAt(p++)),a=r<<2|i>>4,n=(15&i)<<4|o>>2,c=(3&o)<<6|l,s+=String.fromCharCode(a),64!=o&&(s+=String.fromCharCode(n)),64!=l&&(s+=String.fromCharCode(c)),a=n=c="",r=i=o=l="";while(p<t.length);return s}}}),IndiciesAnalysis.factory("CalendarDataService",["$http","$q",function(e,t){var a={getMonthlyExpiries:function(e){var t=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+e),r=n.moveToNthOccurrence(5,3);for(t.push({expiry:{date:r.toString("d-MMM-yyyy")}});a>r;)n.addMonths(1),r=n.moveToNthOccurrence(5,3),t.push({expiry:{date:r.toString("d-MMM-yyyy")}});return t},getWeeklyExpiries:function(e){var t=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+e),r=n.moveToNthOccurrence(5,1);for(t.push({expiry:{date:r.toString("d-MMM-yyyy")}});a>r;)r.addDays(7),t.push({expiry:{date:r.toString("d-MMM-yyyy")}});return t},getOptions:function(e,t,n){if("weekly"==n)var r=a.getWeeklyExpiries(t);else var r=a.getMonthlyExpiries(t);return angular.forEach(r,function(t,a){var n=Date.parse(t.expiry.date);n.addDays(-e),t.open={date:n.toString("d-MMM-yyyy")}}),r}};return a}]),IndiciesAnalysis.factory("MarketDataService",["$http","$q",function(e,t){var a={getDailyMarketData:function(a,n){return marketDataPromise=e.get("/api/get/market-data/local/daily/"+n).then(function(e){if(e){var a=[];return angular.forEach(e.data,function(e,t){var n=Date.parse(e.Date);a[n.getTime()]={date:e.Date,open:e.Open,high:e.High,low:e.Low,close:e.Close}}),a}return t.reject})},getVolatilityData:function(a){return marketDataPromise=e.get("/api/get/market-data/local/daily/VIX").then(function(e){if(e){var a=[];return angular.forEach(e.data,function(e,t){var n=Date.parse(e.Date);a[n.getTime()]={date:e.Date,open:e.Open,high:e.High,low:e.Low,close:e.Close}}),a}return t.reject})}};return a}]),IndiciesAnalysis.factory("OptionCalculationService",["$q",function(e){var t={getOptionData:function(e,a,n,r){return angular.forEach(n,function(n,i){var o=t.getUpdatedDate(Date.parse(n.expiry.date),-r,e,5),s=t.getUpdatedDate(Date.parse(n.open.date),0,e,5),c=e[o.getTime()],l=e[s.getTime()];c&&l?(t.setOptionMarketData(n.expiry,c,o.toString("d-MMM-yyyy")),t.setOptionMarketData(n.open,l,s.toString("d-MMM-yyyy")),t.setOptionVariance(n,e),t.setOptionVolatility(n.expiry,a,5),t.setOptionVolatility(n.open,a,5)):console.log("No market data for: Expiry="+o+", Open="+s)}),n},getUpdatedDate:function(e,t,a,n){var r=new Date(e.getTime());r.addDays(t);for(var i=a[r.getTime()],o=0;!i&&n>=o;)r.addDays(1),i=a[r.getTime()],o++;return r},setOptionMarketData:function(e,t,a){e.date=a,e.open=t.open,e.close=t.close,e.high=t.high,e.low=t.low},setOptionVariance:function(e,t){for(var a=e.open.high,n=e.open.low,r=Date.parse(e.expiry.date),i=Date.parse(e.open.date);r>i;)i.addDays(1),t[i.getTime()]&&(t[i.getTime()].high>a&&(a=t[i.getTime()].high),t[i.getTime()].low<n&&(n=t[i.getTime()].low));e.variance=(e.expiry.close-e.open.open)/e.open.open,e.variance>0?e.highLowVariance=(a-e.open.open)/e.open.open-e.variance:e.highLowVariance=(n-e.open.open)/e.open.open-e.variance},setOptionVolatility:function(e,t,a){for(var n=new Date.parse(e.date),r=0;!t[n.getTime()]&&a>=r;)n.addDays(-1),r++;0==r?e.volatility=t[n.getTime()].open:e.volatility=t[n.getTime()].close}};return t}]),IndiciesAnalysis.directive("indiciesChartDirective",["$parse","$window",function(e,t){return{restrict:"EA",template:"<svg class='chart'></svg>",link:function(a,n,r){function i(){c=v.scale.ordinal().domain(g.map(function(e){return e.expiry.date})).rangeBands([0,m],.3,1),p=v.svg.axis().scale(c).orient("bottom"),l=v.scale.linear().domain(v.extent(g,function(e){return e.variance+e.highLowVariance})).range([x,0]),d=v.svg.axis().scale(l).orient("left").ticks(20,"%").tickSize(-m,0,0),y2=v.scale.linear().domain(v.extent(g,function(e){return e.open.volatility?e.open.volatility/100:0})).range([l(0),0]),y2Axis=v.svg.axis().scale(y2).orient("right").ticks(8,"%").tickSize(-m,0,0),h=v.svg.line().x(function(e){return c(e.expiry.date)}).y(function(e){return e.open.volatility?y2(e.open.volatility/100):y2(0)}).interpolate("linear"),u=v.tip().attr("class","d3-tip").offset([-10,0]).html(function(e){return" <div><span class='title'>Variance: </span><span class='value'>"+(100*e.variance).toFixed(2)+"%</span></div><div><span class='title'>High / Low Variance: </span><span class='value'> "+(100*e.highLowVariance).toFixed(2)+"%</span></div><div><span class='title'>Open Date: </span><span class='value'> "+e.open.date+" </span></div><div><span class='title'>Open Price: </span><span class='value'> "+e.open.open.toFixed(2)+" </span></div><div><span class='title'>Expiry Date: </span><span class='value'>"+e.expiry.date+" </span></div><div><span class='title'>Expiry Price: </span><span class='value'> "+e.expiry.close.toFixed(2)+" </span></div>"}),D.call(u)}function o(e){i(),e?(D.selectAll("g.y").call(d),D.selectAll("g.y2").attr("transform","translate("+m+" ,0)").call(y2Axis),D.selectAll("g.x").attr("transform","translate(0,"+l(0)+")").call(p),D.selectAll(".bar").remove(),D.selectAll(".line").remove()):(D.append("g").attr("class","x axis").attr("transform","translate(0,"+l(0)+")").call(p).selectAll("text"),D.append("g").attr("class","y axis").call(d),D.append("g").attr("class","y2 axis").attr("transform","translate("+m+" ,0)").call(y2Axis)),D.selectAll(".graph-container.bar").data(g).enter().append("rect").attr("class","bar highlow").attr("data-value",function(e){return e.highLowVariance}).attr("x",function(e){return c(e.expiry.date)}).attr("width",c.rangeBand()).attr("y",function(e){return e.highLowVariance?l(Math.max(0,e.highLowVariance+e.variance)):0}).attr("height",function(e){return e.highLowVariance?Math.abs(l(e.highLowVariance+e.variance)-l(0)):0}).on("mouseover",u.show).on("mouseout",u.hide),D.selectAll(".graph-container.bar").data(g).enter().append("rect").attr("class","bar variance").attr("data-value",function(e){return e.variance}).attr("x",function(e){return c(e.expiry.date)}).attr("width",c.rangeBand()).attr("y",function(e){return e.variance?l(Math.max(0,e.variance)):0}).attr("height",function(e){return e.variance?Math.abs(l(e.variance)-l(0)):0}).on("mouseover",u.show).on("mouseout",u.hide),D.append("path").attr("class","line").attr("d",h(g))}function s(){m=parseInt(v.select(".chart").style("width"),10)-f.left-f.right,o(!0)}var c,l,p,d,u,h,y=e(r.chartData),g=y(a),v=t.d3,f={top:20,right:40,bottom:30,left:25},m=parseInt(v.select(".chart").style("width"),10)-f.left-f.right,x=600-f.top-f.bottom,D=v.select(".chart").attr("width",m+f.left+f.right).attr("height",x+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")").attr("class","graph-container");a.$watchCollection(y,function(e,t){g=e;var a=!1;g&&(t&&(a=!0),o(a))}),v.select(window).on("resize",s)}}}]),IndiciesAnalysis.run(["$rootScope","$location","$cookies","$http",function(e,t,a,n){e.currentUser=a.get("currentUser"),e.currentUser&&(n.defaults.headers.common.Authorization="Basic "+e.currentUser),e.$on("$locationChangeStart",function(n,r,i){e.currentUser;"/login"==t.path()||a.get("currentUser")||t.path("/login")})}]),IndiciesAnalysis.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,a){a.html5Mode(!0),t.otherwise("/"),e.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"}).state("login",{name:"login",url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"})}]);var jq=jQuery.noConflict();jq(document).on("mouseenter",".tick text",function(){jq(this).prev("line").css("opacity","1")}),jq(document).on("mouseleave",".tick text",function(){jq(this).prev("line").css("opacity","0")});