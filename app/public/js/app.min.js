IndiciesAnalysis.controller("RootCtrl",["$scope","$http","$q","MarketDataService","CalendarDataService","OptionCalculationService",function(t,e,a,n,i,r){function o(e,o,s,l,c){e||(e="SPY"),o||(o=15),s||(s=0),l||(l="monthly"),c||(c=2e3);var p=n.getDailyMarketData(c,e),d=n.getVolatilityData(c),y=i.getOptions(o,c,l);a.all([p,d]).then(function(e){var a=e[0],n=e[1];if(a&&n){r.getOptionData(a,n,y,s)}t.marketData=y})}o("SPY",15,0,"monthly",2e3),t.marketKeys=["SPY","FTSE","GDAXI","SLV","QQQ","IWM"],t.optionTypes=["weekly","monthly"],t.changeDaysToExpiry=function(){o(t.marketKey,t.openBeforeExpiry,t.closeBeforeExpiry,t.optionType,t.startYear)}}]),IndiciesAnalysis.factory("CalendarDataService",["$http","$q",function(t,e){var a={getMonthlyExpiries:function(t){var e=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+t),i=n.moveToNthOccurrence(5,3);for(e.push({expiry:{date:i.toString("d-MMM-yyyy")}});a>i;)n.addMonths(1),i=n.moveToNthOccurrence(5,3),e.push({expiry:{date:i.toString("d-MMM-yyyy")}});return e},getWeeklyExpiries:function(t){var e=new Array,a=Date.parse("today"),n=Date.parse("1-1-"+t),i=n.moveToNthOccurrence(5,1);for(e.push({expiry:{date:i.toString("d-MMM-yyyy")}});a>i;)i.addDays(7),e.push({expiry:{date:i.toString("d-MMM-yyyy")}});return e},getOptions:function(t,e,n){if("weekly"==n)var i=a.getWeeklyExpiries(e);else var i=a.getMonthlyExpiries(e);return angular.forEach(i,function(e,a){var n=Date.parse(e.expiry.date);n.addDays(-t),e.open={date:n.toString("d-MMM-yyyy")}}),i}};return a}]),IndiciesAnalysis.factory("MarketDataService",["$http","$q",function(t,e){var a={getDailyMarketData:function(a,n){return marketDataPromise=t.get("/api/get/market-data/local/daily/"+n).then(function(t){if(t){var a=[];return angular.forEach(t.data,function(t,e){var n=Date.parse(t.Date);a[n.getTime()]={date:t.Date,open:t.Open,high:t.High,low:t.Low,close:t.Close}}),a}return e.reject})},getVolatilityData:function(a){return marketDataPromise=t.get("/api/get/market-data/local/daily/VIX").then(function(t){if(t){var a=[];return angular.forEach(t.data,function(t,e){var n=Date.parse(t.Date);a[n.getTime()]={date:t.Date,open:t.Open,high:t.High,low:t.Low,close:t.Close}}),a}return e.reject})}};return a}]),IndiciesAnalysis.factory("OptionCalculationService",["$q",function(t){var e={getOptionData:function(t,a,n,i){return angular.forEach(n,function(n,r){var o=e.getUpdatedDate(Date.parse(n.expiry.date),-i,t,5),s=e.getUpdatedDate(Date.parse(n.open.date),0,t,5),l=t[o.getTime()],c=t[s.getTime()];l&&c?(e.setOptionMarketData(n.expiry,l,o.toString("d-MMM-yyyy")),e.setOptionMarketData(n.open,c,s.toString("d-MMM-yyyy")),e.setOptionVariance(n,t),e.setOptionVolatility(n.expiry,a,5),e.setOptionVolatility(n.open,a,5)):console.log("No market data for: Expiry="+o+", Open="+s)}),n},getUpdatedDate:function(t,e,a,n){var i=new Date(t.getTime());i.addDays(e);for(var r=a[i.getTime()],o=0;!r&&n>=o;)i.addDays(1),r=a[i.getTime()],o++;return i},setOptionMarketData:function(t,e,a){t.date=a,t.open=e.open,t.close=e.close,t.high=e.high,t.low=e.low},setOptionVariance:function(t,e){for(var a=t.open.high,n=t.open.low,i=Date.parse(t.expiry.date),r=Date.parse(t.open.date);i>r;)r.addDays(1),e[r.getTime()]&&(e[r.getTime()].high>a&&(a=e[r.getTime()].high),e[r.getTime()].low<n&&(n=e[r.getTime()].low));t.variance=(t.expiry.close-t.open.open)/t.open.open,t.variance>0?t.highLowVariance=(a-t.open.open)/t.open.open-t.variance:t.highLowVariance=(n-t.open.open)/t.open.open-t.variance},setOptionVolatility:function(t,e,a){for(var n=new Date.parse(t.date),i=0;!e[n.getTime()]&&a>=i;)n.addDays(-1),i++;0==i?t.volatility=e[n.getTime()].open:t.volatility=e[n.getTime()].close}};return e}]),IndiciesAnalysis.directive("indiciesChartDirective",["$parse","$window",function(t,e){return{restrict:"EA",template:"<svg class='chart'></svg>",link:function(a,n,i){function r(){s=g.scale.ordinal().rangeRoundBands([0,f],.3),c=g.svg.axis().scale(s).orient("bottom"),s.domain(h.map(function(t){return t.expiry.date})),l=g.scale.linear().range([m,0]),p=g.svg.axis().scale(l).orient("left").ticks(20,"%").tickSize(-f,0,0),l.domain(g.extent(h,function(t){return t.variance+t.highLowVariance})).nice(),y2=g.scale.linear().range([l(0),0]),y2Axis=g.svg.axis().scale(y2).orient("right").ticks(8,"%").tickSize(-f,0,0),y2.domain(g.extent(h,function(t){return t.open.volatility?t.open.volatility/100:0})).nice(),y=g.svg.line().x(function(t){return s(t.expiry.date)}).y(function(t){return t.open.volatility?y2(t.open.volatility/100):y2(0)}).interpolate("linear"),d=g.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return" <div><span class='title'>Variance: </span><span class='value'>"+(100*t.variance).toFixed(2)+"%</span></div><div><span class='title'>High / Low Variance: </span><span class='value'> "+(100*t.highLowVariance).toFixed(2)+"%</span></div><div><span class='title'>Open Date: </span><span class='value'> "+t.open.date+" </span></div><div><span class='title'>Open Price: </span><span class='value'> "+t.open.open.toFixed(2)+" </span></div><div><span class='title'>Expiry Date: </span><span class='value'>"+t.expiry.date+" </span></div><div><span class='title'>Expiry Price: </span><span class='value'> "+t.expiry.close.toFixed(2)+" </span></div>"}),x.call(d)}function o(t){r(),t?(x.selectAll("g.y").call(p),x.selectAll("g.y2").call(y2Axis),x.selectAll("g.x").attr("transform","translate(0,"+l(0)+")").call(c),x.selectAll(".bar").remove(),x.selectAll(".line").remove()):(x.append("g").attr("class","x axis").attr("transform","translate(0,"+l(0)+")").call(c).selectAll("text"),x.append("g").attr("class","y axis").call(p),x.append("g").attr("class","y2 axis").attr("transform","translate("+f+" ,0)").call(y2Axis)),x.selectAll(".graph-container.bar").data(h).enter().append("rect").attr("class","bar highlow").attr("data-value",function(t){return t.highLowVariance}).attr("x",function(t){return s(t.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(t){return t.highLowVariance?l(Math.max(0,t.highLowVariance+t.variance)):0}).attr("height",function(t){return t.highLowVariance?Math.abs(l(t.highLowVariance+t.variance)-l(0)):0}).on("mouseover",d.show).on("mouseout",d.hide),x.selectAll(".graph-container.bar").data(h).enter().append("rect").attr("class","bar variance").attr("data-value",function(t){return t.variance}).attr("x",function(t){return s(t.expiry.date)}).attr("width",s.rangeBand()).attr("y",function(t){return t.variance?l(Math.max(0,t.variance)):0}).attr("height",function(t){return t.variance?Math.abs(l(t.variance)-l(0)):0}).on("mouseover",d.show).on("mouseout",d.hide),x.append("path").attr("class","line").attr("d",y(h))}var s,l,c,p,d,y,u=t(i.chartData),h=u(a),g=e.d3,v={top:20,right:40,bottom:30,left:40},f=1280-v.left-v.right,m=700-v.top-v.bottom,x=g.select(".chart").attr("width",f+v.left+v.right).attr("height",m+v.top+v.bottom).append("g").attr("transform","translate("+v.left+","+v.top+")").attr("class","graph-container");a.$watchCollection(u,function(t,e){h=t;var a=!1;h&&(e&&(a=!0),o(a))})}}}]),IndiciesAnalysis.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(t,e,a){a.html5Mode(!0),e.otherwise("/"),t.state("home",{name:"home",url:"/",templateUrl:"views/home.html",controller:"RootCtrl"})}]);var jq=jQuery.noConflict();jq(document).on("mouseenter",".tick text",function(){jq(this).prev("line").css("opacity","1")}),jq(document).on("mouseleave",".tick text",function(){jq(this).prev("line").css("opacity","0")});